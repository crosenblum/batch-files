@ECHO OFF &SETLOCALTITLE Recursive remove audio and subtitle tracks by language from MKV video filesrem search for MKVs in all "StartFolder\Subfolders", not in "Startfolder" itselfSET "StartFolder=."rem example to keep English and German audio tracks, please note the colon in front of the language codeSET "AudioTracksToKeep=:eng"rem example to keep Spanish and French subtitle tracks, please note the colon in front of the language codeSET "SubsTracksToKeep=:eng"rem the file name variable must be global for some reasonsSET "MKVFile="FOR /f "DELIMS=" %%a IN ('DIR /b /s /a-d "%StartFolder%\*.mkv"') DO SET "MKVFile=%%~a"&CALL:scanmkvGOTO:EOF:scanmkvSETLOCALECHO(ECHO(Scanning "%MKVFile%" for unwanted tracks.(FOR /l %%b IN (1 1 45) DO <nul SET /p "=-")&ECHO(SET /a AudioTrackCount=0SET /a NumberKeepAudio=0SET /a NumberDiscardAudio=0rem get the number of audio tracksFOR /f %%a IN ('mkvmerge --ui-language en -i "%MKVFile%"^|FINDSTR /rbic:"Track ID [0-9][0-9]*: audio"') DO SET /a AudioTrackCount+=1ECHO(Number of audio tracks: %AudioTrackCount%rem always keep at least one audio trackIF %AudioTrackCount% LSS 2 GOTO:subscanrem get the audio tracks to keepSET "KeepAudioSearchString=%AudioTracksToKeep::= language:%"FOR /f "TOKENS=3DELIMS=: " %%a IN ('mkvmerge --ui-language en --identify-verbose "%MKVFile%"^|FINDSTR /rbic:"Track ID [0-9][0-9]*: audio"^|FINDSTR /ri "%KeepAudioSearchString%"') DO (    SET /a NumberKeepAudio+=1    CALL SET "AudioIdentKeepLine=%%AudioIdentKeepLine%%,%%a")IF NOT DEFINED AudioIdentKeepLine SET "AudioIdentKeepLine= ^<none^>"ECHO(ID of %NumberKeepAudio% track(s) to keep: %AudioIdentKeepLine:~1%IF %NumberKeepAudio%==0 GOTO:subscanrem get the audio tracks to rejectFOR /f "TOKENS=3DELIMS=: " %%a IN ('mkvmerge --ui-language en --identify-verbose "%MKVFile%"^|FINDSTR /rbic:"Track ID [0-9][0-9]*: audio"^|FINDSTR /riv "%KeepAudioSearchString%"') DO (    SET /a NumberDiscardAudio+=1    CALL SET "AudioIdentDiscardLine=%%AudioIdentDiscardLine%%,%%a")IF NOT DEFINED AudioIdentDiscardLine SET "AudioIdentDiscardLine= ^<none^>"ECHO(ID of %NumberDiscardAudio% track(s) to reject: %AudioIdentDiscardLine:~1%IF %NumberDiscardAudio%==0 GOTO:subscan:subscanSET /a SubsTrackCount=0SET /a NumberKeepSubs=0SET /a NumberDiscardSubs=0rem get the number of subtitle tracksFOR /f %%a IN ('mkvmerge --ui-language en -i "%MKVFile%"^|FINDSTR /rbic:"Track ID [0-9][0-9]*: subtitles"') DO SET /a SubsTrackCount+=1ECHO(Number of subtitle tracks: %SubsTrackCount%IF %SubsTrackCount% EQU 0 GOTO:muxingrem get the subtitle tracks to keepSET "KeepSubsSearchString=%SubsTracksToKeep::= language:%"FOR /f "TOKENS=3DELIMS=: " %%a IN ('mkvmerge --ui-language en --identify-verbose "%MKVFile%"^|FINDSTR /rbic:"Track ID [0-9][0-9]*: subtitles"^|FINDSTR /ri "%KeepSubsSearchString%"') DO (    SET /a NumberKeepSubs+=1    CALL SET "SubsIdentKeepLine=%%SubsIdentKeepLine%%,%%a")IF NOT DEFINED SubsIdentKeepLine SET "SubsIdentKeepLine= ^<none^>"ECHO(ID of %NumberKeepSubs% track(s) to keep: %SubsIdentKeepLine:~1%IF %NumberKeepSubs%==0 GOTO:muxingrem get the subtitle tracks to rejectFOR /f "TOKENS=3DELIMS=: " %%a IN ('mkvmerge --ui-language en --identify-verbose "%MKVFile%"^|FINDSTR /rbic:"Track ID [0-9][0-9]*: subtitles"^|FINDSTR /riv "%KeepSubsSearchString%"') DO (    SET /a NumberDiscardSubs+=1    CALL SET "SubsIdentDiscardLine=%%SubsIdentDiscardLine%%,%%a")IF NOT DEFINED SubsIdentDiscardLine SET "SubsIdentDiscardLine= ^<none^>"ECHO(ID of %NumberDiscardSubs% track(s) to reject: %SubsIdentDiscardLine:~1%IF %NumberDiscardSubs%==0 GOTO:muxing:muxingIF %NumberDiscardAudio%==0 IF %NumberDiscardSubs%==0 ECHO(Nothing to do.&EXIT /bIF %NumberDiscardAudio% NEQ 0 SET "CommandLine=-a %AudioIdentKeepLine:~1%"IF %NumberDiscardSubs% NEQ 0 SET "CommandLine=%Commandline% -s %SubsIdentKeepLine:~1%"rem make a backup copy of the MKVFOR %%a IN ("%MKVFile%") DO SET "MKVBackupFile=%%~na.bak%%~xa"ECHO(Building "%MKVBackupFile%"REN "%MKVFile%" "%MKVBackupFile%" || (ECHO(Error renaming to "%MKVBackupFile%"&EXIT /b)rem build the new MKVFOR %%a IN ("%MKVFile%") DO SET "MKVBackupFile=%%~dpa%MKVBackupFile%"ECHO(REMuxing "%MKVFile%"mkvmerge -o "%MKVFile%" %Commandline% "%MKVBackupFile%"EXIT /b
